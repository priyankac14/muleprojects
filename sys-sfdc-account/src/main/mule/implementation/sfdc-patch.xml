<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns:salesforce="http://www.mulesoft.org/schema/mule/salesforce"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/salesforce http://www.mulesoft.org/schema/mule/salesforce/current/mule-salesforce.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<sub-flow name="sfdc-patch-subFlow" doc:id="18292d8f-a861-422e-a7de-36fceae514f4" >
		<until-successful maxRetries="${retry.count}" doc:name="retry" doc:id="68d48271-9ebf-4894-82a0-0801fac93257" millisBetweenRetries="${retry.interval}">
			<try doc:name="Try" doc:id="c0a0fbd2-1ae0-4b4c-89a9-1fe9f7aa64f3" >
				<ee:transform doc:name="Transform Message" doc:id="3724137b-f04c-42f8-a6ea-6c476f4e1c02">
			<ee:message>
						<ee:set-payload resource="dwl/xformtosfdc.dwl" />
						<ee:set-attributes resource="dwl/xformtosfdc.dwl" />
			</ee:message>
		</ee:transform>
				<logger level="INFO" doc:name="Logger" doc:id="e1c52771-af11-423f-bb3c-4dfcbceb58cf" message="#[payload]"/>
				<salesforce:upsert doc:name="Upsert" doc:id="6e16fc0b-02b7-4ee8-9897-1ecdeb16adef" config-ref="Salesforce_Config" objectType="Account" externalIdFieldName="ExternalAccountId__c" />
				<ee:transform doc:name="Transform Message" doc:id="6668ffde-d488-48f2-aae9-1b85b59905ce">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
payload]]></ee:set-payload>
			</ee:message>
		</ee:transform>
				<logger level="INFO" doc:name="Logger" doc:id="26ca5c5a-2629-4a3f-9847-fafb807ea928" message="#[payload]" category="salesforceresponse" />
				<ee:transform doc:name="Transform Message" doc:id="bd1db167-c86b-4677-a071-4f1e94db8381" >
					<ee:message >
						<ee:set-payload resource="dwl/successorerrormsg.dwl" />
						<ee:set-attributes resource="dwl/successorerrormsg.dwl" />
					</ee:message>
				</ee:transform>
				<error-handler >
					<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="88c102a4-db8d-4997-af38-3662a7090a7b" type="SALESFORCE:CONNECTIVITY, SALESFORCE:TIMEOUT">
						<logger level="INFO" doc:name="Logger" doc:id="4689657c-edd5-407d-9bd2-508df2a65110" message="#[error]"/>
					</on-error-propagate>
					<on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="d218f673-3722-4cce-98bf-6c72d1e073e5" >
						<logger level="INFO" doc:name="Logger" doc:id="df9c160b-53e7-4f01-906a-0565795e1456" message="#[error]"/>
						<set-variable value="#[error]" doc:name="Set Variable" doc:id="adf42658-e468-41dc-9f10-dfa704f8ba3e" variableName="processingError"/>
					</on-error-continue>
				</error-handler>
			</try>
		</until-successful>
		<choice doc:name="Choice" doc:id="d199440a-af27-417b-bfa7-500cafa9a750" >
			<when expression="#[!(isEmpty(vars.processingError))]">
				<ee:transform doc:name="Transform Message" doc:id="3afd8531-b387-4ee2-a631-7af64f13911f">
					<ee:message>
						<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
	"status": "failed",
	"error": vars.processingError
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
				<raise-error doc:name="Raise error" doc:id="ad6befa7-1c58-45ab-a61e-1d88358db570" type="SFDC:ONERRORCONTINUEERROR" description='"record processing failed"'/>
			</when>
			<otherwise >
				<logger level="INFO" doc:name="Logger" doc:id="7ccb7e16-ed01-48e4-b4f6-c75c0d2d4855" message='#["Successfully Created/Updated in Salesforce"]'/>
			</otherwise>
		</choice>
	</sub-flow>
</mule>
